<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Habit Tracker</title>
    <style>
        /* Design System Variables */
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --font-family-base: 'FKGroteskNeue', 'Geist', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            
            /* Custom tracker colors */
            --color-header-bg: #e3f2fd;
            --color-habit-bg: #f5f5f5;
            --color-checked-bg: #d4edda;
            --color-grid-border: #dee2e6;
            --color-progress-green: #28a745;
            --color-weekend-bg: #f8f9fa;
            --color-red: #dc3545;
            --color-yellow: #ffc107;
            --color-green: #28a745;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-header-bg: rgba(29, 78, 216, 0.15);
                --color-habit-bg: rgba(119, 124, 124, 0.1);
                --color-weekend-bg: rgba(119, 124, 124, 0.05);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            padding: var(--space-20);
            line-height: 1.5;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background-color: var(--color-header-bg);
            padding: var(--space-24);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-24);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-16);
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-16);
            flex-wrap: wrap;
        }

        h1 {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            color: var(--color-text);
        }

        .month-selector {
            padding: var(--space-8) var(--space-16);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            cursor: pointer;
            font-family: var(--font-family-base);
        }

        .header-stats {
            display: flex;
            align-items: center;
            gap: var(--space-20);
            flex-wrap: wrap;
        }

        .overall-progress {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-text);
        }

        .motivational-msg {
            font-size: var(--font-size-base);
            font-weight: 500;
            padding: var(--space-8) var(--space-16);
            background-color: rgba(var(--color-teal-500-rgb), 0.1);
            border-radius: var(--radius-base);
            color: var(--color-primary);
        }

        .clear-btn {
            padding: var(--space-8) var(--space-16);
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 500;
            transition: background-color 0.2s;
            font-family: var(--font-family-base);
        }

        .clear-btn:hover {
            background-color: var(--color-primary-hover);
        }

        .tracker-wrapper {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            box-shadow: var(--shadow-md);
            overflow-x: auto;
            margin-bottom: var(--space-24);
        }

        .tracker-grid {
            display: grid;
            grid-template-columns: 200px repeat(30, 50px) 100px 80px 150px;
            gap: 0;
            min-width: fit-content;
        }

        .cell {
            border: 1px solid var(--color-grid-border);
            padding: var(--space-8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            background-color: var(--color-surface);
        }

        .habit-cell {
            background-color: var(--color-habit-bg);
            font-weight: 500;
            justify-content: flex-start;
            padding-left: var(--space-12);
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .header-cell {
            font-weight: 600;
            background-color: var(--color-header-bg);
            position: sticky;
            top: 0;
            z-index: 3;
        }

        .week-header {
            grid-column: span 7;
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            font-size: var(--font-size-sm);
            position: sticky;
            top: 0;
            z-index: 3;
        }

        .week-5-header {
            grid-column: span 2;
        }

        .day-cell {
            font-weight: 600;
            font-size: var(--font-size-sm);
            background-color: var(--color-header-bg);
            position: sticky;
            top: 32px;
            z-index: 3;
        }

        .weekend {
            background-color: var(--color-weekend-bg);
        }

        .today-indicator {
            background-color: rgba(var(--color-teal-500-rgb), 0.2) !important;
            font-weight: 700;
        }

        .checkbox-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .checkbox-cell:hover {
            background-color: rgba(var(--color-teal-500-rgb), 0.05);
        }

        .checkbox-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-progress-green);
        }

        .checkbox-cell.checked {
            background-color: var(--color-checked-bg);
        }

        .stats-header {
            font-weight: 600;
            font-size: var(--font-size-sm);
            background-color: var(--color-header-bg);
            position: sticky;
            top: 32px;
            z-index: 3;
        }

        .stats-cell {
            font-size: var(--font-size-sm);
            font-weight: 500;
        }

        .progress-bar-cell {
            padding: var(--space-4);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--color-habit-bg);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--color-progress-green);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: 600;
        }

        .daily-progress-label {
            background-color: var(--color-habit-bg);
            font-weight: 600;
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .daily-progress-cell {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .daily-progress-cell.low {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--color-red);
        }

        .daily-progress-cell.medium {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--color-yellow);
        }

        .daily-progress-cell.high {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--color-green);
        }

        .chart-container {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-24);
        }

        .chart-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--space-16);
            color: var(--color-text);
        }

        .chart-wrapper {
            width: 100%;
            height: 300px;
            position: relative;
        }

        @media (max-width: 768px) {
            body {
                padding: var(--space-12);
            }

            h1 {
                font-size: var(--font-size-xl);
            }

            .header {
                padding: var(--space-16);
            }

            .tracker-grid {
                grid-template-columns: 150px repeat(30, 45px) 80px 70px 120px;
            }

            .habit-cell {
                font-size: 11px;
            }

            .checkbox-cell input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }
        }
        .habit-edit-input {
            width: 100%;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            padding: 4px 6px;
            font-size: var(--font-size-base);
            background: var(--color-surface);
            color: var(--color-text);
        }

    </style>
</head>
<body>
    <div id="overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;display:none;"></div>
    <div id="sidebar" style="position:fixed;left:-280px;top:0;width:280px;height:100vh;background:white;box-shadow:2px 0 15px rgba(0,0,0,0.2);z-index:1000;transition:left 0.3s;">
        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;font-weight:bold;">
            Menu
            <button id="closeBtn" style="background:none;border:none;color:white;font-size:26px;cursor:pointer;">âœ•</button>
        </div>
        <button id="profileBtn" style="width:100%;padding:15px 20px;background:none;border:none;text-align:left;cursor:pointer;font-size:15px;transition:background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">ðŸ‘¤ Edit Profile</button>
        <button id="logoutBtn" style="width:100%;padding:15px 20px;background:none;border:none;text-align:left;cursor:pointer;font-size:15px;color:#d32f2f;font-weight:600;border-top:1px solid #eee;margin-top:10px;transition:background 0.2s;" onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='none'">ðŸšª Logout</button>
    </div>

    <div class="container">

            <div class="header">
            <div class="header-left">
                <button id="menuBtn" style="background:none;border:none;font-size:26px;cursor:pointer;margin-right:10px;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.15)';this.style.color='#667eea'" onmouseout="this.style.transform='scale(1)';this.style.color='#333'">â˜°</button>
                <h1>MY HABIT TRACKER</h1>
                <select class="month-selector" id="monthSelector">
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10" selected>November</option>
                    <option value="11">December</option>
                </select>
                <input type="number" class="month-selector" id="yearSelector" 
                       min="1900" max="2100" step="1" 
                       placeholder="Year" style="width: 90px; text-align: center;" />
            </div>
            <div class="header-stats">
                <div class="overall-progress" id="overallProgress">Overall: 0%</div>
                <div class="motivational-msg" id="motivationalMsg">Keep going! ðŸ’ª</div>
                <button class="clear-btn" id="clearBtn">Clear All</button>
            </div>
        </div>

        <div class="tracker-wrapper">
            <div class="tracker-grid" id="trackerGrid">
                </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Monthly Progress Trend</div>
            <div class="chart-wrapper">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    
    <script>
        var m=document.getElementById('menuBtn'),s=document.getElementById('sidebar'),o=document.getElementById('overlay'),c=document.getElementById('closeBtn'),l=document.getElementById('logoutBtn'),p=document.getElementById('profileBtn');
        function cls(){s.style.left='-280px';o.style.display='none';}
        m.onclick=function(){s.style.left='0';o.style.display='block';};
        c.onclick=function(){cls();};
        o.onclick=function(){cls();};
        l.onclick=function(){firebase.auth().signOut().then(function(){window.location.href='login.html';}).catch(function(e){alert('Error: '+e.message);});};
        p.onclick=function(){alert('Profile editing coming soon!');cls();};
    </script>
    <script>


        // Firebase Auth check - Login verification
        window.addEventListener('DOMContentLoaded', function() {
          if (firebase && firebase.auth) {
            firebase.auth().onAuthStateChanged(function(user) {
              if (!user) {
                // à¤²à¥‰à¤—à¤‡à¤¨ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ - redirect to login
                window.location.href = 'login.html';
              }
            });
          } else {
            // firebase config à¤¯à¤¾ script missing
            alert('Firebase configuration missing!');
          }
        });

        // Habit data - à¤¯à¤¹ à¤…à¤¬ à¤¹à¤®à¥‡à¤¶à¤¾ DEFAULT/ORIGINAL à¤²à¤¿à¤¸à¥à¤Ÿ à¤°à¤¹à¥‡à¤—à¥€à¥¤
        const defaultHabits = [
            { id: 1, name: 'Wake up at 05:00', emoji: 'â°' },
            { id: 2, name: 'Gym', emoji: 'ðŸ’ª' },
            { id: 3, name: 'Reading / Learning', emoji: 'ðŸ“š' },
            { id: 4, name: 'Open Demat', emoji: 'ðŸ“ˆ' },
            { id: 5, name: 'Budget Tracking', emoji: 'ðŸ’°' },
            { id: 6, name: 'Study', emoji: 'ðŸ“–' },
            { id: 7, name: 'No Alcohol', emoji: 'ðŸ·' },
            { id: 8, name: 'Social Media Detox', emoji: 'ðŸ”•' },
            { id: 9, name: 'Goal Journaling', emoji: 'âœï¸' }
        ];

        const weeks = [
            { week: 1, days: [1, 2, 3, 4, 5, 6, 7] },
            { week: 2, days: [8, 9, 10, 11, 12, 13, 14] },
            { week: 3, days: [15, 16, 17, 18, 19, 20, 21] },
            { week: 4, days: [22, 23, 24, 25, 26, 27, 28] },
            { week: 5, days: [29, 30] }
        ];

        const daysInMonth = 30;
        let totalHabits; 

        // State management (in-memory)
        let habitState = {};
        // New state for habit names in the CURRENT month/year
        let currentHabits = []; 
        let currentMonth = 10; // November (0-indexed)
        let currentYear = new Date().getFullYear();
        let todayDate = 23; // Current date in November


        // --- Habit Name Persistence Logic ---

        // Function to get the month-specific storage key
        function getMonthHabitKey(month, year) {
            return `habitNames-v1-${month}-${year}`;
        }

        // Initialize habits array based on month/year
        function initializeHabits() {
            const monthKey = getMonthHabitKey(currentMonth, currentYear);
            const savedNames = localStorage.getItem(monthKey);
            
            if (savedNames) {
                // 1. Current month à¤•à¥‡ à¤²à¤¿à¤ à¤¨à¤¾à¤® à¤¸à¥‡à¤µ à¤¹à¥ˆà¤‚, à¤‰à¤¨à¥à¤¹à¥‡à¤‚ à¤²à¥‹à¤¡ à¤•à¤°à¥‹à¥¤
                try {
                    currentHabits = JSON.parse(savedNames);
                } catch (e) {
                    console.error('Failed to parse saved habit names', e);
                    // Fallback: à¤…à¤—à¤° parsing fail à¤¹à¥‹à¤¤à¥€ à¤¹à¥ˆ, à¤¤à¥‹ default habits à¤•à¤¾ à¤‡à¤¸à¥à¤¤à¥‡à¤®à¤¾à¤² à¤•à¤°à¥‹à¥¤
                    currentHabits = JSON.parse(JSON.stringify(defaultHabits)); 
                }
            } else {
                // 2. Current month à¤•à¥‡ à¤²à¤¿à¤ à¤¨à¤¾à¤® à¤¸à¥‡à¤µ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¤‚, default habits à¤•à¤¾ à¤‡à¤¸à¥à¤¤à¥‡à¤®à¤¾à¤² à¤•à¤°à¥‹à¥¤
                // Deep copy of default habits.
                currentHabits = JSON.parse(JSON.stringify(defaultHabits)); 
                
                // IMPORTANT: Save defaults immediately for the current month so they aren't loaded again on reload,
                // and any future changes are applied to this month's data.
                saveHabitNames(); 
            }
            
            totalHabits = currentHabits.length;
        }

        // Save habit names for the CURRENT month/year
        function saveHabitNames() {
            const monthKey = getMonthHabitKey(currentMonth, currentYear);
            localStorage.setItem(monthKey, JSON.stringify(currentHabits));
        }

        // Function to initialize the habit state (checkboxes)
        function initializeState() {
            habitState = {};
            // State initialization MUST use currentHabits (which holds the month's names)
            currentHabits.forEach(habit => { 
                habitState[habit.id] = {};
                for (let day = 1; day <= daysInMonth; day++) {
                    habitState[habit.id][day] = false;
                }
            });
        }


        // ---- LocalStorage persistence for Checkboxes ----

        function saveHabitState() {
            const monthKey = `habitState-v1-${currentMonth}-${currentYear}`;
            localStorage.setItem(monthKey, JSON.stringify(habitState));
        }

        function loadHabitState() {
            const monthKey = `habitState-v1-${currentMonth}-${currentYear}`;
            const saved = localStorage.getItem(monthKey);
            if (saved) {
                try {
                    const tempState = JSON.parse(saved);
                    
                    // Check if habit IDs in saved state match currentHabits IDs (important for data consistency)
                    const loadedIds = Object.keys(tempState).map(id => parseInt(id));
                    const currentIds = currentHabits.map(habit => habit.id);

                    if (loadedIds.length === currentIds.length && 
                        loadedIds.every(id => currentIds.includes(id))) {
                        habitState = tempState;
                        return;
                    }
                } catch (e) {
                    console.error('Failed to parse saved habit state', e);
                }
            }
            // If no saved state or IDs don't match, initialize fresh state for the month
            initializeState();
        }

        // Toggle checkbox
        function toggleCheckbox(habitId, day) {
            // Safety check: ensure habitId exists in the state
            if (!habitState[habitId]) {
                console.error(`Habit ID ${habitId} not found in state.`);
                return;
            }
            habitState[habitId][day] = !habitState[habitId][day];
            saveHabitState();
            updateUI();
        }

        // Calculate statistics for a habit
        function calculateHabitStats(habitId) {
            let completed = 0;
            // Check if habitId exists in habitState before iterating
            if (!habitState[habitId]) return { completed: 0, progress: 0 }; 

            for (let day = 1; day <= daysInMonth; day++) {
                if (habitState[habitId][day]) completed++;
            }
            const progress = Math.round((completed / daysInMonth) * 100);
            return { completed, progress };
        }

        // Calculate daily progress
        function calculateDailyProgress(day) {
            let completed = 0;
            currentHabits.forEach(habit => { // Use currentHabits
                // Check if habitState and habitState[habit.id] are initialized
                if (habitState[habit.id] && habitState[habit.id][day]) completed++;
            });
            // Use totalHabits for calculation
            return totalHabits === 0 ? 0 : Math.round((completed / totalHabits) * 100); 
        }

        // Calculate overall progress
        function calculateOverallProgress() {
            let totalChecked = 0;
            let totalPossible = totalHabits * daysInMonth; // Use totalHabits
            if (totalPossible === 0) return 0;
            
            currentHabits.forEach(habit => { // Use currentHabits
                for (let day = 1; day <= daysInMonth; day++) {
                    if (habitState[habit.id] && habitState[habit.id][day]) totalChecked++;
                }
            });
            return Math.round((totalChecked / totalPossible) * 100);
        }

        // Get motivational message
        function getMotivationalMessage(progress) {
            if (progress <= 30) return 'Keep going! ðŸ’ª';
            if (progress <= 60) return 'Good progress! ðŸŒŸ';
            if (progress <= 80) return 'Great work! ðŸ”¥';
            return 'Amazing dedication! ðŸ†';
        }

        // Check if day is weekend (6th and 7th day of each week)
        function isWeekend(day) {
            const weekendDays = [6, 7, 13, 14, 20, 21, 27, 28];
            return weekendDays.includes(day);
        }

        // Generate the tracker grid
        function generateGrid() {
            const grid = document.getElementById('trackerGrid');
            grid.innerHTML = '';
            
            // Dynamically set the grid columns based on the number of days in the month
            grid.style.gridTemplateColumns = `200px repeat(${daysInMonth}, 50px) 100px 80px 150px`;

            // Header row - Week labels (Adjusted for 30 days)
            const emptyCorner = document.createElement('div');
            emptyCorner.className = 'cell header-cell';
            emptyCorner.textContent = 'Habits';
            grid.appendChild(emptyCorner);

            const weekHeaders = [
                { span: 7, text: 'Week 1' },
                { span: 7, text: 'Week 2' },
                { span: 7, text: 'Week 3' },
                { span: 7, text: 'Week 4' },
                { span: 2, text: 'Week 5' }
            ];

            weekHeaders.forEach(header => {
                const weekHeader = document.createElement('div');
                weekHeader.className = `cell week-header week-${header.text.slice(-1)}-header`;
                weekHeader.style.gridColumn = `span ${header.span}`;
                weekHeader.textContent = header.text;
                grid.appendChild(weekHeader);
            });

            // Stats headers
            const completedHeader = document.createElement('div');
            completedHeader.className = 'cell stats-header';
            completedHeader.textContent = 'Completed';
            grid.appendChild(completedHeader);

            const progressHeader = document.createElement('div');
            progressHeader.className = 'cell stats-header';
            progressHeader.textContent = 'Progress %';
            grid.appendChild(progressHeader);

            const barHeader = document.createElement('div');
            barHeader.className = 'cell stats-header';
            barHeader.textContent = 'Progress Bar';
            grid.appendChild(barHeader);

            // Day numbers row
            const habitCorner = document.createElement('div');
            habitCorner.className = 'cell header-cell';
            grid.appendChild(habitCorner);

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'cell day-cell';
                if (isWeekend(day)) dayCell.classList.add('weekend');
                if (day === todayDate && currentMonth === new Date().getMonth() && currentYear === new Date().getFullYear()) {
                    dayCell.classList.add('today-indicator');
                }
                dayCell.textContent = day;
                grid.appendChild(dayCell);
            }

            // Empty stats cells for day row
            for (let i = 0; i < 3; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'cell header-cell';
                grid.appendChild(emptyCell);
            }

            // Habit rows
            currentHabits.forEach(habit => { // Use currentHabits
                // Habit name cell
                const habitCell = document.createElement('div');
                habitCell.className = 'cell habit-cell';
                habitCell.innerHTML = `${habit.emoji} ${habit.name}`;

                // Double-click to edit habit name
                habitCell.addEventListener('dblclick', () => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = habit.name;
                    input.className = 'habit-edit-input';

                    habitCell.innerHTML = '';
                    habitCell.appendChild(input);
                    input.focus();
                    input.select();

                    const finishEdit = () => {
                        let newName = input.value.trim();
                        if (newName.length > 30) {
                            newName = newName.slice(0, 30);
                        }
                        if (!newName) {
                            newName = habit.name;
                        }
                        
                        // *** THE KEY CHANGE: Update the name in the currentHabits array AND save it ***
                        const habitToUpdate = currentHabits.find(h => h.id === habit.id);
                        if(habitToUpdate) {
                            habitToUpdate.name = newName;
                            saveHabitNames(); // Save the updated list of names for the current month
                        }
                        
                        habitCell.innerHTML = `${habit.emoji} ${newName}`;
                    };

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') finishEdit();
                    });

                    input.addEventListener('blur', finishEdit);
                });

                grid.appendChild(habitCell);

                // Checkbox cells for each day
                for (let day = 1; day <= daysInMonth; day++) {
                    const checkboxCell = document.createElement('div');
                    checkboxCell.className = 'cell checkbox-cell';
                    if (isWeekend(day)) checkboxCell.classList.add('weekend');
                    if (day === todayDate && currentMonth === new Date().getMonth() && currentYear === new Date().getFullYear()) {
                        checkboxCell.classList.add('today-indicator');
                    }
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `habit-${habit.id}-day-${day}`;
                    checkbox.checked = habitState[habit.id] ? habitState[habit.id][day] : false;
                    checkbox.addEventListener('change', () => toggleCheckbox(habit.id, day));
                    
                    checkboxCell.appendChild(checkbox);
                    if (habitState[habit.id] && habitState[habit.id][day]) {
                        checkboxCell.classList.add('checked');
                    }
                    grid.appendChild(checkboxCell);
                }

                // Stats cells
                const stats = calculateHabitStats(habit.id);
                
                const completedCell = document.createElement('div');
                completedCell.className = 'cell stats-cell';
                completedCell.id = `completed-${habit.id}`;
                completedCell.textContent = stats.completed;
                grid.appendChild(completedCell);

                const progressCell = document.createElement('div');
                progressCell.className = 'cell stats-cell';
                progressCell.id = `progress-${habit.id}`;
                progressCell.textContent = `${stats.progress}%`;
                grid.appendChild(progressCell);

                const progressBarCell = document.createElement('div');
                progressBarCell.className = 'cell progress-bar-cell';
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                const progressFill = document.createElement('div');
                progressFill.className = 'progress-fill';
                progressFill.id = `bar-${habit.id}`;
                progressFill.style.width = `${stats.progress}%`;
                progressBar.appendChild(progressFill);
                progressBarCell.appendChild(progressBar);
                grid.appendChild(progressBarCell);
            });

            // Daily progress row
            const dailyProgressLabel = document.createElement('div');
            dailyProgressLabel.className = 'cell daily-progress-label';
            dailyProgressLabel.textContent = 'Daily Progress';
            grid.appendChild(dailyProgressLabel);

            for (let day = 1; day <= daysInMonth; day++) {
                const dailyProgress = calculateDailyProgress(day);
                const dailyCell = document.createElement('div');
                dailyCell.className = 'cell daily-progress-cell';
                dailyCell.id = `daily-${day}`;
                
                if (dailyProgress <= 50) dailyCell.classList.add('low');
                else if (dailyProgress <= 75) dailyCell.classList.add('medium');
                else dailyCell.classList.add('high');
                
                dailyCell.textContent = `${dailyProgress}%`;
                grid.appendChild(dailyCell);
            }

            // Empty cells for daily progress row
            for (let i = 0; i < 3; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'cell';
                grid.appendChild(emptyCell);
            }
        }

        // Update UI after state change
        function updateUI() {
            // Update checkboxes and their background colors
            currentHabits.forEach(habit => { // Use currentHabits
                for (let day = 1; day <= daysInMonth; day++) {
                    const checkbox = document.getElementById(`habit-${habit.id}-day-${day}`);
                    if (checkbox) {
                        checkbox.checked = habitState[habit.id] ? habitState[habit.id][day] : false;
                        const cell = checkbox.parentElement;
                        if (habitState[habit.id] && habitState[habit.id][day]) {
                            cell.classList.add('checked');
                        } else {
                            cell.classList.remove('checked');
                        }
                    }
                }

                // Update stats
                const stats = calculateHabitStats(habit.id);
                const completedEl = document.getElementById(`completed-${habit.id}`);
                const progressEl = document.getElementById(`progress-${habit.id}`);
                const barEl = document.getElementById(`bar-${habit.id}`);
                
                if (completedEl) completedEl.textContent = stats.completed;
                if (progressEl) progressEl.textContent = `${stats.progress}%`;
                if (barEl) barEl.style.width = `${stats.progress}%`;
            });

            // Update daily progress
            for (let day = 1; day <= daysInMonth; day++) {
                const dailyProgress = calculateDailyProgress(day);
                const dailyEl = document.getElementById(`daily-${day}`);
                if (dailyEl) {
                    dailyEl.textContent = `${dailyProgress}%`;
                    dailyEl.className = 'cell daily-progress-cell';
                    if (dailyProgress <= 50) dailyEl.classList.add('low');
                    else if (dailyProgress <= 75) dailyEl.classList.add('medium');
                    else dailyEl.classList.add('high');
                }
            }

            // Update overall progress
            const overallProgress = calculateOverallProgress();
            document.getElementById('overallProgress').textContent = `Overall: ${overallProgress}%`;
            document.getElementById('motivationalMsg').textContent = getMotivationalMessage(overallProgress);

            // Update chart
            drawChart();
        }

        // Draw trend chart
        function drawChart() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return; // Safety check
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = 300;
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Calculate data points
            const dataPoints = [];
            for (let day = 1; day <= daysInMonth; day++) {
                const progress = calculateDailyProgress(day);
                dataPoints.push(progress);
            }

            // Draw axes
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-border');
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Draw y-axis labels
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-text-secondary');
            ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--font-family-base');
            ctx.textAlign = 'right';
            for (let i = 0; i <= 100; i += 25) {
                const y = height - padding - (i / 100) * chartHeight;
                ctx.fillText(i + '%', padding - 10, y + 4);
            }

            // Draw x-axis labels (every 5 days)
            ctx.textAlign = 'center';
            for (let i = 1; i <= daysInMonth; i += 5) {
                const x = padding + ((i - 1) / (daysInMonth - 1)) * chartWidth;
                ctx.fillText(i, x, height - padding + 20);
            }

            // Draw area chart
            if (dataPoints.length > 0) {
                ctx.beginPath();
                ctx.moveTo(padding, height - padding);

                dataPoints.forEach((value, index) => {
                    const x = padding + (index / (daysInMonth - 1)) * chartWidth;
                    const y = height - padding - (value / 100) * chartHeight;
                    if (index === 0) {
                        ctx.lineTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.lineTo(padding + chartWidth, height - padding);
                ctx.closePath();
                
                // Fill gradient
                const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
                gradient.addColorStop(0, 'rgba(40, 167, 69, 0.3)');
                gradient.addColorStop(1, 'rgba(40, 167, 69, 0.05)');
                ctx.fillStyle = gradient;
                ctx.fill();

                // Draw line
                ctx.beginPath();
                dataPoints.forEach((value, index) => {
                    const x = padding + (index / (daysInMonth - 1)) * chartWidth;
                    const y = height - padding - (value / 100) * chartHeight;
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.strokeStyle = '#28a745';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw points
                ctx.fillStyle = '#28a745';
                dataPoints.forEach((value, index) => {
                    const x = padding + (index / (daysInMonth - 1)) * chartWidth;
                    const y = height - padding - (value / 100) * chartHeight;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
        }

        // Helper function to get month name
        function getMonthName(monthIndex) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthIndex];
        }

        // Clear data with two options - Current Month or All Data
        function clearAll() {
            const choice = confirm(
                'What do you want to clear?\n\n' +
                'OK = Clear Current Month (' + getMonthName(currentMonth) + ' ' + currentYear + ')\n' +
                'Cancel = Clear All Data (all months & years)'
            );

            if (choice === true) {
                // Clear only current month's checkboxes AND reset habit names to default for current month
                initializeState(); // Resets habitState to empty
                saveHabitState();
                
                // Reset habit names for the current month to defaultHabits
                currentHabits = JSON.parse(JSON.stringify(defaultHabits));
                saveHabitNames(); 
                
                generateGrid(); // Regenerate grid with default names
                updateUI();
                alert('âœ… ' + getMonthName(currentMonth) + ' ' + currentYear + ' cleared!');
            } else {
                // Clear all data - ask for confirmation
                const confirmAll = confirm(
                    'âš ï¸ This will delete ALL saved data (Habits Names & Checkboxes)!\n\n' +
                    'Are you sure? (This cannot be undone)'
                );
                if (confirmAll) {
                    // Clear all localStorage data
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        // Clear both habit state and habit names across all months/years
                        if (key.startsWith('habitState-v1-') || key.startsWith('habitNames-v1-')) { 
                            localStorage.removeItem(key);
                        }
                    });
                    // Reset in-memory state
                    initializeHabits(); // Will load defaults and save them for the current month
                    initializeState();
                    generateGrid();
                    updateUI();
                    alert('âœ… All data deleted! Fresh start!');
                }
            }
        }

        // Initialize year input with current year
        function populateYearSelector() {
            const yearInput = document.getElementById('yearSelector');
            // Set to current year if no value is set, or if the stored value is out of range
            const currentYearVal = new Date().getFullYear();
            yearInput.value = currentYearVal;
            currentYear = currentYearVal;
            // Set the month selector to the current month as well
            document.getElementById('monthSelector').value = new Date().getMonth();
            currentMonth = new Date().getMonth();
        }

        // Year input change
        function changeYear() {
            const inputValue = document.getElementById('yearSelector').value;
            if (inputValue && inputValue >= 1900 && inputValue <= 2100) {
                currentYear = parseInt(inputValue);
                // Load the month-specific names for the new year
                initializeHabits(); 
                // Load the checkbox state for the new month/year
                loadHabitState();
                generateGrid();
                updateUI();
                drawChart();
            }
        }

        // Month selector change
        function changeMonth() {
            currentMonth = parseInt(document.getElementById('monthSelector').value);
            // Load the month-specific names for the new month
            initializeHabits(); 
            // Load the checkbox state for the new month/year
            loadHabitState();
            generateGrid();
            updateUI();
            drawChart();
        }


        // Initialize the app
        function init() {
            populateYearSelector();
            initializeHabits(); // Load names FIRST (from month-specific localstorage or defaults)
            loadHabitState();   // Load state based on currentHabits IDs
            generateGrid();
            updateUI();
            
            // Event listeners
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            document.getElementById('monthSelector').addEventListener('change', changeMonth);
            document.getElementById('yearSelector').addEventListener('input', changeYear);
            document.getElementById('yearSelector').addEventListener('change', changeYear);
            
            // Redraw chart on window resize
            window.addEventListener('resize', () => {
                drawChart();
            });
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script src="config.js">

        // Logout button function
        function insertLogoutButton() {
          var container = document.getElementById('logout-container');
          if (!container) return;
          const btn = document.createElement('button');
          btn.textContent = 'Logout';
          btn.style.background = 'red';
          btn.style.color = 'white';
          btn.style.border = 'none';
          btn.style.padding = '6px 18px';
          btn.style.borderRadius = '5px';
          btn.style.fontWeight = 'bold';
          btn.style.cursor = 'pointer';
          btn.style.fontSize = '14px';
          btn.onclick = function() {
              firebase.auth().signOut().then(() => {
                window.location.href = 'login.html';
              }).catch((error) => {
                alert('Logout error: ' + error.message);
              });
          };
          container.appendChild(btn);
        }

        // Initialize logout button when page loads
        document.addEventListener('DOMContentLoaded', function() {
          insertLogoutButton();
        });
</script>

<footer style="margin-top: 24px; text-align: center; font-size: 12px; opacity: 0.7;">
  <a href="about.html">About / Contact</a> |
  <a href="privacy.html">Privacy Policy</a>
</footer>

</body>
</html>
